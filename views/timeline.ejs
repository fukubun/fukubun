<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fukubun Timeline</title>
  <link href="/tailwind.css" rel="stylesheet">
</head>
<body class="bg-white dark:bg-gray-900">

<main class="relative z-0 max-w-3xl mx-auto p-6 md:pl-48">


  <ol class="timeline relative">

    <% if (posts && posts.length) { %>
      <% posts.forEach(post => { %>
        <li class="mb-3 relative border-b border-gray-200 dark:border-gray-700 last:border-b-0 pb-3">



          <div class="flex gap-3 items-start">

            <a href="/profile/<%= post.username %>">
              <img src="<%= post.userIcon || userMap[post.username] %>" class="w-10 h-10 rounded-full object-cover" alt="<%= post.user %>のアイコン">
            </a>

            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-semibold text-gray-900"><%= post.user %></span>
                <span class="text-gray-500 text-sm"><%= post.username %></span>
                <span class="text-gray-500 text-sm">· <%= post.time %></span>
              </div>

              <% 
                const lines = String(post.message)
                  .replace(/\r/g, '')
                  .split('\n')
                  .filter(line => line.trim() !== '');
              %>
              <% if (lines.length > 0) { %>
                <p class="text-gray-900 leading-relaxed whitespace-pre-line m-0"><%= lines.join('\n') %></p>
              <% } %>

              <% if (post.image) { %>
                <img src="<%= post.image %>" class="w-full rounded-lg mt-3 border object-cover" alt="投稿画像">
              <% } %>

              <div class="flex justify-between text-gray-500 text-sm mt-3 select-none items-center">
                <button class="hover:text-green-500 transition-colors">リポスト</button>

                <button class="like-btn inline-flex items-center gap-1" data-id="<%= post.id %>" aria-label="いいね">
                  <% if (post.likedUsers && post.likedUsers.includes(user.username)) { %>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="red" stroke="red" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"/>
                    </svg>
                  <% } else { %>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"/>
                    </svg>
                  <% } %>

                  <span class="text-sm"><%= post.likes %></span>
                </button>

                <button class="hover:text-gray-700 transition-colors">ブックマーク</button>

                <% if (post.username === user.username) { %>

  <!-- 削除を開くボタン（type="button" にして即時 submit を防ぐ） -->
  <button
    type="button"
    data-modal-target="deleteModal-<%= post.id %>"
    data-modal-toggle="deleteModal-<%= post.id %>"
    class="hover:text-red-600 transition-colors">
    削除
  </button>

  <!-- 削除モーダル -->
  <div id="deleteModal-<%= post.id %>" tabindex="-1" aria-hidden="true"
       class="hidden overflow-y-auto overflow-x-hidden fixed inset-0 z-50 flex items-center justify-center
              w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">

    <div class="relative p-4 w-full max-w-md max-h-full">
      <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">

        <!-- ヘッダー -->
        <div class="flex items-center justify-between p-4 md:p-5 rounded-t">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            投稿を削除しますか？
          </h3>
          <button type="button"
                  class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg
                         text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600
                         dark:hover:text-white"
                  data-modal-hide="deleteModal-<%= post.id %>">
            ✕
          </button>
        </div>

        <!-- 本文 -->
        <div class="p-4 md:p-5 space-y-4">
          <p class="text-base leading-relaxed text-gray-500 dark:text-gray-400">
            この操作は取り消せません。  
            本当に削除してよろしいですか？
          </p>
        </div>

        <!-- フッター（モーダル内フォーム） -->
        <div class="flex items-center justify-end p-4 md:p-5 rounded-b gap-3">

          <!-- モーダル内のフォームで初めて submit する -->
          <form action="/delete/<%= post.id %>" method="POST" class="delete-form m-0">
            <input type="hidden" name="redirect" value="timeline">
            <!-- CSRF トークンを使っている場合はここに hidden input を追加 -->
            <button type="submit" class="hover:text-red-500 transition-colors px-4 py-2">
              削除する
            </button>
          </form>

          <button type="button" data-modal-hide="deleteModal-<%= post.id %>"
                  class="ms-3 text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none
                         focus:ring-blue-300 rounded-lg border border-gray-300 text-sm font-medium
                         px-5 py-2.5 hover:text-gray-900 dark:bg-gray-700 dark:text-gray-300
                         dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600
                         dark:focus:ring-gray-600">
            キャンセル
          </button>

        </div>

      </div>
    </div>
  </div>


                <% } else { %>
                  <!-- レイアウトを揃えるための不可視プレースホルダ -->
                  <button class="invisible pointer-events-none" aria-hidden="true">削除</button>
                <% } %>

              </div>
            </div>

          </div>
        </li>
      <% }) %>
    <% } else { %>
      <li class="mb-10">
        <p class="text-gray-500">投稿がありません。投稿してみましょう。</p>
      </li>
    <% } %>

  </ol>

</main>

<!-- スピードダイヤル（そのまま） -->
<div data-dial-init class="fixed end-6 bottom-6 group z-50">
  <div id="speed-dial-menu-default" class="flex flex-col items-center hidden mb-4 space-y-2">
    <button type="button" class="flex justify-center items-center w-[52px] h-[52px] bg-gray-100 text-gray-700 rounded-full border border-gray-300 shadow hover:bg-gray-200">
      <!-- svg -->
    </button>
  </div>

  <a href="/post" class="flex items-center justify-center text-white bg-blue-600 rounded-full w-14 h-14 hover:bg-blue-700 shadow-lg">
    <svg class="w-6 h-6 transition-transform group-hover:rotate-45" fill="none" viewBox="0 0 24 24">
      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/>
    </svg>
  </a>
</div>


<button id="menuBtn" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded shadow">
  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" stroke="currentColor" fill="none" stroke-width="2">
    <path d="M3 6h18M3 12h18M3 18h18"/>
  </svg>
</button>

<!-- 左固定サイドバー（PCのみ表示） -->
<aside class="hidden sm:block fixed top-0 left-0 z-40 w-48 h-screen bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">

  <div class="h-full flex flex-col items-start py-4 px-4">

    <!-- ホーム -->
    <a href="/timeline" class="mb-6 flex items-center gap-3 text-gray-700 hover:text-blue-500">
      <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/>
        <path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
      </svg>
      <span class="text-base font-medium">ホーム</span>
    </a>

    <!-- プロフィール -->
    <a href="/profile" class="mb-6 flex items-center gap-3 text-gray-700 hover:text-blue-500">
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2 21a8 8 0 0 1 10.821-7.487"/>
        <path d="M21.378 16.626a1 1 0 0 0-3.004-3.004l-4.01 4.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/>
        <circle cx="10" cy="8" r="5"/>
      </svg>
      <span class="text-base font-medium">プロフィール</span>
    </a>

    <!-- 匿名 -->
    <a href="/tokumei" class="mb-6 flex items-center gap-3 text-gray-700 hover:text-blue-500">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2 6h4"/><path d="M2 10h4"/><path d="M2 14h4"/><path d="M2 18h4"/>
        <rect width="16" height="20" x="4" y="2" rx="2"/>
        <path d="M9.5 8h5"/><path d="M9.5 12H16"/><path d="M9.5 16H14"/>
      </svg>
      <span class="text-base font-medium">匿名投稿</span>
    </a>

    <!-- 質問 -->
    <a href="/question" class="mb-6 flex items-center gap-3 text-gray-700 hover:text-blue-500">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M6 8.5a6.5 6.5 0 1 1 13 0c0 6-6 6-6 10a3.5 3.5 0 1 1-7 0"/>
        <path d="M15 8.5a2.5 2.5 0 0 0-5 0v1a2 2 0 1 1 0 4"/>
      </svg>
      <span class="text-base font-medium">質問</span>
    </a>

    <!-- 読書 -->
    <a href="/reads" class="mb-6 flex items-center gap-3 text-gray-700 hover:text-blue-500">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect width="8" height="18" x="3" y="3" rx="1"/>
        <path d="M7 3v18"/>
        <path d="M20.4 18.9c.2.5-.1 1.1-.6 1.3l-1.9.7c-.5.2-1.1-.1-1.3-.6L11.1 5.1c-.2-.5.1-1.1.6-1.3l1.9-.7c.5-.2 1.1.1 1.3.6Z"/>
      </svg>
      <span class="text-base font-medium">読書</span>
    </a>

    <!-- 日記 -->
    <a href="/diary" class="mb-6 flex items-center gap-3 text-gray-700 hover:text-blue-500">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M13 21h8"/><path d="m15 5 4 4"/>
        <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/>
      </svg>
      <span class="text-base font-medium">日記</span>
    </a>

    <!-- ログアウト -->
    <a href="/home" class="mb-6 flex items-center gap-3 text-gray-700 hover:text-blue-500">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m16 17 5-5-5-5"/><path d="M21 12H9"/><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
      </svg>
      <span class="text-base font-medium">ログアウト</span>
    </a>

    <!-- ユーザー -->
    <div class="mt-auto mb-4 flex items-center gap-3">
      <img src="<%= user.icon %>" class="w-9 h-9 rounded-full object-cover">
      <span class="text-base font-medium"><%= user.username %></span>
    </div>

  </div>
</aside>

<script>
  const btn = document.getElementById("menuBtn");
  const menu = document.getElementById("mobileMenu");

  btn.addEventListener("click", () => {
    menu.classList.toggle("-translate-x-full");
  });
</script>


<script src="/js/like.js"></script>

</body>
</html>