<main class="max-w-2xl mx-auto p-6">

  <!-- タイトル -->
  <div class="flex items-center justify-center relative mb-6">
<a id="backButton"
   href="<%=
     query.from === 'reads'
       ? '/reads'
       : query.from === 'finished'
         ? '/reads_shelf#finished'
         : '/reads_shelf'
   %>"
   class="absolute left-0 text-gray-500 hover:text-gray-700 text-xl font-bold">
  ✕
</a>
    <h1 class="text-2xl font-semibold text-center"><%= book.title %></h1>
  </div>

  <form action="/shelf/<%= book._id %>/save" method="POST" class="space-y-6">

<div id="readingTimer" class="text-gray-600 mt-2 hidden">
  読書中: <span id="timerText">00:00</span>
</div>

<div class="p-3 bg-gray-50 border rounded-md text-sm text-gray-700 space-y-1">

  <p>追加日: <%= book.createdAt.toLocaleDateString() %></p>

  <p>最終読書日: 
    <%= book.lastReadAt ? book.lastReadAt.toLocaleDateString() : '—' %>
  </p>

<p>読了日:
  <%= book.finishedAt ? book.finishedAt.toLocaleDateString() : '—' %>
</p>

  <p>累計読書時間: 
    <% 
      const hrs = Math.floor(book.totalReadingSeconds / 3600);
      const mins = Math.floor((book.totalReadingSeconds % 3600) / 60);
    %>
    <%= hrs %>時間 <%= mins %>分
  </p>

</div>

<button id="startReading" type="button"
        class="px-4 py-2 bg-gray-800 text-white rounded-md">
  読む
</button>

<button id="pauseReading" type="button"
        class="hidden px-4 py-2 bg-yellow-600 text-white rounded-md">
  一時停止
</button>

<button id="resumeReading" type="button"
        class="hidden px-4 py-2 bg-green-700 text-white rounded-md">
  再開
</button>

<button id="stopReading" type="button"
        class="hidden inline-block px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 ml-2">
  終了
</button>

<button id="finishReading" type="button"
        class="hidden inline-block px-4 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800 ml-2">
  読了
</button>

    <!-- 読中メモ -->
    <div>
      <label class="block mb-2 font-medium">読中メモ</label>
      <textarea name="readingNote"
                class="w-full p-3 border rounded-md"
                rows="6"><%= book.readingNote %></textarea>
    </div>

    <!-- 感想 -->
    <div>
      <label class="block mb-2 font-medium">感想</label>
      <textarea name="review"
                class="w-full p-3 border rounded-md"
                rows="6"><%= book.review %></textarea>
    </div>

   <button id="saveButton" type="submit"
        class="px-4 py-2 bg-blue-600 text-white rounded-md">
  保存
</button>

  </form>

</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const startBtn = document.getElementById("startReading");
  const stopBtn = document.getElementById("stopReading");
  const pauseBtn = document.getElementById("pauseReading");
  const resumeBtn = document.getElementById("resumeReading");
  const backBtn = document.getElementById("backButton");
  const saveBtn = document.getElementById("saveButton");
  const timerBox = document.getElementById("readingTimer");
  const timerText = document.getElementById("timerText");

  // ★ 読了ボタン
  const finishBtn = document.getElementById("finishReading");

  const STORAGE_KEY = `readingState_<%= book._id %>`;

  let timer = null;
  let seconds = 0;
  let isReading = false;
  let isPaused = false;

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      seconds,
      isReading,
      isPaused
    }));
  }

  function loadState() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return;

    const state = JSON.parse(data);
    seconds = state.seconds || 0;
    isReading = state.isReading || false;
    isPaused = state.isPaused || false;
  }

  function updateTimer() {
    seconds++;
    const m = String(Math.floor(seconds / 60)).padStart(2, "0");
    const s = String(seconds % 60).padStart(2, "0");
    timerText.textContent = `${m}:${s}`;
    saveState();
  }

  loadState();

  // --- 復元：読書中 ---
  if (isReading && !isPaused) {
    timer = setInterval(updateTimer, 1000);
    timerBox.classList.remove("hidden");
    startBtn.classList.add("hidden");
    pauseBtn.classList.remove("hidden");
    stopBtn.classList.remove("hidden");
    finishBtn.classList.remove("hidden"); // ★ 読了ボタン表示
    backBtn.classList.add("hidden");
  }

  // --- 復元：一時停止中 ---
  if (isPaused) {
    timerBox.classList.remove("hidden");
    startBtn.classList.add("hidden");
    resumeBtn.classList.remove("hidden");
    stopBtn.classList.remove("hidden");
    finishBtn.classList.remove("hidden"); // ★ 読了ボタン表示
    backBtn.classList.remove("hidden");
  }

  timerText.textContent =
    `${String(Math.floor(seconds / 60)).padStart(2, "0")}:${String(seconds % 60).padStart(2, "0")}`;

  // --- 読む ---
  startBtn.addEventListener("click", () => {
    if (!timer) timer = setInterval(updateTimer, 1000);

    isReading = true;
    isPaused = false;
    saveState();

    fetch(`/shelf/<%= book._id %>/setReadingState`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ isReading: true })
    });

    fetch(`/shelf/<%= book._id %>/updateLastRead`, { method: "POST" });

    timerBox.classList.remove("hidden");
    startBtn.classList.add("hidden");
    pauseBtn.classList.remove("hidden");
    stopBtn.classList.remove("hidden");
    finishBtn.classList.remove("hidden"); // ★ 読了ボタン表示
    backBtn.classList.add("hidden");
  });

  // --- ★ 一時停止 ---
  pauseBtn.addEventListener("click", () => {
    clearInterval(timer);
    timer = null;

    isPaused = true;
    saveState();

    pauseBtn.classList.add("hidden");
    resumeBtn.classList.remove("hidden");
    stopBtn.classList.remove("hidden");
    finishBtn.classList.remove("hidden"); // ★ 読了ボタン表示
    backBtn.classList.remove("hidden");
  });

  // --- ★ 再開 ---
  resumeBtn.addEventListener("click", () => {
    if (!timer) timer = setInterval(updateTimer, 1000);

    isPaused = false;
    saveState();

    resumeBtn.classList.add("hidden");
    pauseBtn.classList.remove("hidden");
    stopBtn.classList.remove("hidden");
    finishBtn.classList.remove("hidden"); // ★ 読了ボタン表示
    backBtn.classList.add("hidden");
  });

  // --- 終了 ---
  stopBtn.addEventListener("click", () => {
    clearInterval(timer);
    timer = null;

    fetch(`/shelf/<%= book._id %>/addReadingTime`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ seconds })
    });

    fetch(`/shelf/<%= book._id %>/setReadingState`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ isReading: false })
    });

    isReading = false;
    isPaused = false;
    seconds = 0;

    localStorage.removeItem(STORAGE_KEY);

    timerBox.classList.add("hidden");
    startBtn.classList.remove("hidden");
    pauseBtn.classList.add("hidden");
    resumeBtn.classList.add("hidden");
    stopBtn.classList.add("hidden");
    finishBtn.classList.add("hidden"); // ★ 読了ボタン非表示
    backBtn.classList.remove("hidden");

    timerText.textContent = "00:00";
  });

  // --- ★ 読了 ---
finishBtn.addEventListener("click", () => {
  clearInterval(timer);
  timer = null;

  // 読了 API
  fetch(`/shelf/<%= book._id %>/finish`, {
    method: "POST",
    headers: { "Content-Type": "application/json" }
  });

  // 状態リセット
  isReading = false;
  isPaused = false;
  seconds = 0;
  localStorage.removeItem(STORAGE_KEY);

  // 読了本棚へ遷移（タブを finished に自動で切り替え）
  window.location.href = "/reads_shelf#finished";
});

  saveBtn.addEventListener("click", (e) => {
    if (isReading && !isPaused) {
      e.preventDefault();
    }
  });
});
</script>